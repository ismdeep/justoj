{extend name="extra@layout/user" /}

{block name='titlepart'}{$problem->problem_id} - {$problem->title} - {$lang['justoj']}{/block}


{block name="body"}
<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
			"HTML-CSS": {linebreaks: {automatic: true}}
		});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<!--题目内容显示页面 begin-->
<div class="container">
	<h2 align="center">
		{if $problem->ac}
		<span class="glyphicon glyphicon-ok" style="color: green"></span>
		{/if}
		{if $problem->pending}
		<span class="glyphicon glyphicon-hand-right" style="color: red"></span>
		{/if}
		{$problem->problem_id}: {$problem->title}
	</h2>
	<div align="center">
		<div class="panel panel-default">
			<div class="panel-body">
				<span class=green>{$lang.time_limit}: </span>C/C++ {$problem->time_limit} s &nbsp;&nbsp;&nbsp;&nbsp; Java/Python {$problem->time_limit * 3} s &nbsp;&nbsp;&nbsp;&nbsp;
				<span class=green>{$lang.memory_limit}: </span>{$problem->memory_limit} MB &nbsp;&nbsp;&nbsp;&nbsp;
				<span class=green>{$lang.accepted}: </span><a href="/status?problem_id={$problem->problem_id}&result=4" target="_blank">{$problem->solved}</a> &nbsp;&nbsp;&nbsp;&nbsp;
				<span class=green>{$lang.submit}: </span><a href="/status?problem_id={$problem->problem_id}" target="_blank">{$problem->submit}</a>
			</div>
		</div>

		<!--功能按钮组 begin-->
		<button type="button" class="btn btn-success" onclick="show_submit_code_modal()">{$lang.submit}</button>
		{if $loginuser}
		<a href="/status?username={$loginuser->user_id}&problem_id={$problem->problem_id}" target="_blank" type="button" class="btn btn-default">{$lang.my_status}</a>
		{/if}

		{if $is_administrator}
		<a href="/admin/problem/edit?id={$problem->problem_id}" class="btn btn-primary" target="_blank">{$lang.edit}</a>
		<a href="/admin/problem/files?problem_id={$problem->problem_id}" class="btn btn-primary" target="_blank">{$lang.test_data}</a>
		{/if}

		{if $is_root}
		<button class="btn btn-danger" onclick="rejudge_problem({$problem->problem_id})">{$lang.rejudge}</button>
		{/if}
		<!--功能按钮组 end-->
	</div>
	<h3>{$lang.problem_description}</h3>
	<div class="content">
		{$problem->description}
	</div>
	<h3>{$lang.input}</h3>
	<div class=content>{$problem->input}</div>
	<h3>{$lang.output}</h3>
	<div class=content>{$problem->output}</div>
	<h3>{$lang.sample_input}</h3>
	<pre><span class=sampledata>{$problem->sample_input}</span></pre>
	<h3>{$lang.sample_output}</h3>
	<pre><span class=sampledata>{$problem->sample_output}</span></pre>
	<h3>{$lang.hint}</h3>
	<div>{$problem->hint}</div>
	<h3>{$lang.source}</h3>
	<div class=content>
		<p><a href='/problems?keyword={$problem->source}'>{$problem->source}</a></p>
	</div>
	<br>
	<div align="center">
		<!--功能按钮组 begin-->
		<button type="button" class="btn btn-success" onclick="show_submit_code_modal()">{$lang.submit}</button>
		{if $loginuser}
		<a href="/status?username={$loginuser->user_id}&problem_id={$problem->problem_id}" target="_blank" type="button" class="btn btn-default">{$lang.my_status}</a>
		{/if}

		{if $is_root}
		<button class="btn btn-danger">{$lang.rejudge}</button>
		{/if}
		<!--功能按钮组 end-->
	</div>
</div>
<!--题目内容显示页面 end-->

<!--登录所用之模态框 begin-->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">
					<span>×</span>
				</button>
				<h4 class="modal-title" id="loginModalLabel">Login</h4>
			</div>
			<div class="modal-body">
				<form id="login-form">
					<div class="form-group">
						<label for="login-username" class="form-control-label">{$lang.username}:</label>
						<input type="text" class="form-control" id="login-username" placeholder="{$lang.username}">
					</div>
					<div class="form-group">
						<label for="login-password" class="form-control-label">{$lang.password}:</label>
						<input type="password" class="form-control" id="login-password" placeholder="{$lang.password}">
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<div class="alert alert-danger" role="alert" id="login-alert" style="display: none;"></div>
				<button type="button" class="btn btn-secondary" data-dismiss="modal">{$lang.cancel}</button>
				<button type="button" class="btn btn-primary" id="btn-login" onclick="login()">{$lang.login}</button>
			</div>
		</div>
	</div>
</div>
<!--登录所用之模态框 end-->

<!--提交代码所用之模态框 begin-->
<div class="modal fade" id="submitModal" tabindex="-1" role="dialog" aria-labelledby="submitModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
				<h4 class="modal-title" id="submitModalLabel">{$lang.submit_code}</h4>
			</div>
			<div class="modal-body">
				<form id="submit-form">
					<div class="form-group">
						<div class="row">
							<label for="submit-language" class="col-md-2 col-form-label" style="text-align: right">{$lang.language}:</label>
							<div class="col-md-10">
								<select class="form-control custom-select" name="language" id="submit-language" onchange="language_change()">
									{volist name="allowed_langs" id="item"}
									<option value="{$item.id}">{$item.name} ({$item.version})</option>
									{/volist}
								</select>
							</div>
						</div>
						<br>
						<div class="row">
							<label for="submit-source" class="col-md-2 col-form-label" style="text-align: right">{$lang.source_code}:</label>
							<div class="col-md-10">
								<textarea class="form-control" style="font-family: Consolas,Courier,monospace;" name="source" id="submit-source" rows="15" placeholder="At least 50 characters"></textarea>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<div class="alert alert-danger" role="alert" id="submit-alert" style="display: none"></div>
				<button type="button" class="btn btn-default" data-dismiss="modal">{$lang.cancel}</button>
				<button type="button" class="btn btn-primary" id="btn-submit" onclick="submit_code()">{$lang.submit}</button>
			</div>
		</div>
	</div>
</div>
<!--提交代码所用之模态框 end-->

<!--测试结果之模态框 begin-->
<div class="modal fade" id="solutionModal" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">
					<a href="javascript:void(0)">
						<i class="fa fa-close"></i>
					</a>
				</button>
				<h5 class="modal-title" id="solutionModalLabel"><a target="_blank">#<span id="solution_id"></span></a></h5>
			</div>
			<div class="modal-body">
				<div id="info-panel">
					<table class="table table-reflow">
						<thead>
						<tr>
							<th>{$lang.run_id}</th>
							<th>{$lang.status}</th>
							<th>{$lang.code_length}</th>
							<th>{$lang.memory}</th>
							<th>{$lang.exe_time}</th>
							<th>{$lang.language}</th>
							<th>{$lang.submit_time}</th>
						</tr>
						</thead>
						<tbody>
						<tr>
							<td><span id="solution_id_2"></span></td>
							<td><span id="solution-result"></span><span id="solution-pending-spin">&nbsp;<i class="fa fa-refresh fa-spin"></i></span></td>
							<td id="solution-code-length"></td>
							<td id="solution-memory"></td>
							<td id="solution-exe-time"></td>
							<td id="solution-code-language"></td>
							<td id="solution-submittime"></td>
						</tr>
						</tbody>
					</table>
				</div>
				<div id="code-panel">
					<pre id="solution-source-code" style="padding: 0px;tab-size: 4"></pre>
				</div>
				<div id="compile-info-panel" hidden>
					<pre id="solution-compile-error"></pre>
				</div>
				<div class="alert alert-warning" role="alert" id="ce-info" style="display: none"></div>
			</div>
		</div>
	</div>
</div>
<!--测试结果之模态框 end-->

<script type="text/javascript">
var solution_result_color = {
    'result_code_pending': 'black',
    'result_code_rejuding': 'black',
    'result_code_compiling': 'black',
    'result_code_running': 'black',
    'result_code_ac': 'green',
    'result_code_pe': 'black',
    'result_code_wa': 'red',
    'result_code_tle': 'red',
    'result_code_mle': 'red',
    'result_code_ole': 'red',
    'result_code_re': 'red',
    'result_code_ce': 'red',
    'result_code_co': 'black',
    'result_code_tr': 'black',
    'result_code_so': 'black'
}

function show_submit_code_modal(){
    $('#compile-info-panel').hide();
    $('#submit-source').val('');
    layer.msg('提交中....', {
        icon: 16
        ,shade: 0.01
    });
    // 先判断用户是否已经登录
    $.get('/api/Login/islogin',function(d){
        layer.closeAll();
        if ('success' == d.status) {
            $('#submitModal').modal('show');
        }else{
            $('#loginModal').modal('show');
        }
    },'json');
}

function login(){
    var loginData = {
        'username': $('#login-username').val(),
		'password': $('#login-password').val()
	};
    $.post('/api/Login/login',loginData,function(d){
        if ('success' == d.status) {
            $('#loginModal').modal('hide');
            show_submit_code_modal();
		}else{
            $('#loginModal').modal('hide');
            layer.alert(d.msg,{},function(index){
                layer.close(index);
                show_submit_code_modal();
			});
		}
	},'json');
}

function status_monitor(solution_id){
    $.get('/api/Solution/status?solution_id='+solution_id,function(d){
        console.log(d);
        if (d.data.result < 4) {
            $('#solution-result').html(d.data.result_text);
            setTimeout(status_monitor(solution_id),300);
		}else{
            $('#solution-result').html(d.data.result_text);
            $('#solution-result').css('color', solution_result_color[d.data.result_code]);
            $('#solution-memory').html(d.data.memory+' B');
            $('#solution-exe-time').html(d.data.time+' ms');
            /* 如果是编译错误还要显示编译错误信息 */
			if ('11' == d.data.result) {
			    $('#solution-compile-error').html(d.data.compile_info.error);
			    $('#compile-info-panel').show();
			}
            $('#solution-pending-spin').hide();
		}
	},'json');
}

function submit_code(){
    layer.msg('提交中....', {
        icon: 16
        ,shade: 0.01
    });
    var codeData = {
        'problem_id': {$problem->problem_id},
        'language': $('#submit-language').val(),
		'code': $('#submit-source').val()
	};
    $.post('/api/solution/submit_problem_code',codeData,function(d){
        layer.closeAll();
        if ('success' == d.status) {
            console.log(d);
            $('#solution_id').html(d.data.solution_id);
            $('#solution_id_2').html(d.data.solution_id);
            $('#solution-code-length').html(d.data.code_length+' B');
            $('#solution-memory').html('--');
            $('#solution-exe-time').html('--');
            $('#solution-code-language').html(d.data.language_text);
            $('#solution-submittime').html(d.data.in_date);
            $('#solution-result').html('{$lang.contest_code_pending}');
            $('#solution-result').css('color', 'black');
            $('#solution-source-code').html('<code class="'+d.data.language_text+'">'+d.data.source_code.source+'</code>');
            $('#submitModal').modal('hide');
            $('#solutionModal').modal('show');

            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });

            $('#solution-pending-spin').show();
            // 监控题目状态
			status_monitor(d.data.solution_id);
		}else{
            layer.alert(d.msg);
		}
	},'json');
}

// 源代码语言切换
function language_change(){
    var lang_val = document.getElementById('submit-language').value;
    console.log(lang_val);
    localStorage.setItem("lang_val", lang_val);
}

// 重判题目
function rejudge_problem(problem_id) {
    layer.confirm('{$lang.are_you_sure_to_rejudge_this_problem}',function(){
        $.get('/api/Solution/rejudge_problem?problem_id='+problem_id,function(d){
            if ('success' == d.status) {
                layer.alert('Rejudging');
			}else{
                layer.alert(d.msg);
			}
		},'json');
	});
}


$(function(){
	// 自动初始化语言
    var lang_val = localStorage.getItem('lang_val');
    if (null == lang_val || undefined == lang_val) {
        lang_val = 0;
    }
    document.getElementById('submit-language').value = lang_val;
});
</script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

{/block}
