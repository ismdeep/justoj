{extend name="extra@themes/bootstrap/layout-contest/contest-layout" /}

{block name='titlepart'}{$alphabet[$contest_problem->num]}:{$problem->title} - {$contest->title} - 江西理工大学编程俱乐部{/block}

{block name="body"}
<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
			"HTML-CSS": {linebreaks: {automatic: true}}
		});
	</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<div class="container">
	<ul id="myTab" class="nav nav-tabs">
		{volist name='contest_problems' id='p'}
		<li{if $contest_problem->num == $p->num} class="active"{/if}><a href="/contest/Problem?id={$contest->contest_id}&pid={$p->num}">{if $p->ac}<span class="glyphicon glyphicon-ok" style="color: green"></span>&nbsp;{/if}
		{if $p->pending}<span class="glyphicon glyphicon-hand-right" style="color: red"></span>&nbsp;{/if}{$alphabet[$p->num]}</a></li>
		{/volist}
	</ul>
	<h2 align="center">
		{if $contest_problem->ac}
		<span class="glyphicon glyphicon-ok" style="color: green"></span>
		{/if}
		{if $contest_problem->pending}
		<span class="glyphicon glyphicon-hand-right" style="color: red"></span>
		{/if}
		{$alphabet[$contest_problem->num]}: {$problem->title}</h2>
	<div align="center">
		<div class="panel panel-default">
			<div class="panel-body">
				<span class=green>{$lang.time_limit}: </span>{$problem->time_limit} s &nbsp;&nbsp;&nbsp;&nbsp;
				<span class=green>{$lang.memory_limit}: </span>{$problem->memory_limit} MB &nbsp;&nbsp;&nbsp;&nbsp;
				<!--<span class=green>{$lang.accepted}: </span><a href="/status?problem_id={$problem->problem_id}&result=4" target="_blank">{$problem->solved}</a> &nbsp;&nbsp;&nbsp;&nbsp;-->
				<!--<span class=green>{$lang.submit}: </span><a href="/status?problem_id={$problem->problem_id}" target="_blank">{$problem->submit}</a>-->
			</div>
		</div>

		<!--功能按钮组 begin-->
		<button type="button" class="btn btn-success" onclick="show_submit_code_modal()">{$lang.submit}</button>
		{if $loginuser}
		<a href="/contest/Status?id={$contest->contest_id}&run_id=&username={$loginuser->user_id}&problem_id={$contest_problem->num}" target="_blank" type="button" class="btn btn-default">{$lang.my_status}</a>
		{/if}

		{if $is_administrator}
		<a href="/admin/Problem/edit?id={$problem->problem_id}" class="btn btn-primary" target="_blank">{$lang.edit}</a>
		<a href="/admin/Problem/files?problem_id={$problem->problem_id}" class="btn btn-primary" target="_blank">{$lang.test_data}</a>
		{/if}

		{if $is_root}
		<button class="btn btn-danger" onclick="layer.alert('暂未开放')">{$lang.rejudge}</button>
		{/if}
		<!--功能按钮组 end-->
	</div>
	<h3>{$lang.problem_description}</h3>
	<div class="content">
		{$problem->description}
	</div>
	<h3>{$lang.input}</h3>
	<div class=content>{$problem->input}</div>
	<h3>{$lang.output}</h3>
	<div class=content>{$problem->output}</div>
	<h3>{$lang.sample_input}</h3>
	<pre><span class=sampledata>{$problem->sample_input}</span></pre>
	<h3>{$lang.sample_output}</h3>
	<pre><span class=sampledata>{$problem->sample_output}</span></pre>
	<h3>{$lang.hint}</h3>
	<div>{$problem->hint}</div>
	<h3>{$lang.source}</h3>
	<div class=content>
		<p><a href='/problem/search?source={$problem->source}'>{$problem->source}</a></p>
	</div>
	<div class="content">
		<a href="/problem?id={$problem->problem_id}" target="_blank">Original Problem Link</a>
	</div>
	<br>
	<div align="center">
		<!--功能按钮组 begin-->
		<button type="button" class="btn btn-success" onclick="show_submit_code_modal()">{$lang.submit}</button>
		{if $loginuser}
		<a href="/contest/Status?id={$contest->contest_id}&run_id=&username={$loginuser->user_id}&problem_id={$contest_problem->num}" target="_blank" type="button" class="btn btn-default">{$lang.my_status}</a>
		{/if}

		{if $is_root}
		<button class="btn btn-danger" onclick="layer.alert('暂未开放')">{$lang.rejudge}</button>
		{/if}
		<!--功能按钮组 end-->
	</div>
</div>


<!--提交代码所用之模态框 begin-->
<div class="modal fade" id="submitModal" tabindex="-1" role="dialog" aria-labelledby="submitModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
				<h4 class="modal-title" id="submitModalLabel">{$lang.submit_code}</h4>
			</div>
			<div class="modal-body">
				<form id="submit-form">
					<div class="form-group">
						<div class="row">
							<label for="submit-language" class="col-md-2 col-form-label" style="text-align: right">{$lang.language}:</label>
							<div class="col-md-10">
								<select class="form-control custom-select" name="language" id="submit-language" onchange="language_change()">
									{volist name="allowed_langs" id="item"}
									<option value="{$item.id}">{$item.name} ({$item.version})</option>
									{/volist}
								</select>
							</div>
						</div>
						<br>
						<div class="row">
							<label for="submit-source" class="col-md-2 col-form-label" style="text-align: right">{$lang.source_code}:</label>
							<div class="col-md-10">
								<textarea onclick="$('#submit-alert').hide();" class="form-control" style="font-family: Consolas,Courier,monospace;" name="source" id="submit-source" rows="15" placeholder="At least 50 characters"></textarea>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<div class="alert alert-danger" role="alert" id="submit-alert" style="display: none"></div>
				<button type="button" class="btn btn-secondary" data-dismiss="modal">{$lang.cancel}</button>
				<button type="button" class="btn btn-primary" id="btn-submit" onclick="submit_code()">{$lang.submit}</button>
			</div>
		</div>
	</div>
</div>
<!--提交代码所用之模态框 end-->


<!--登录所用之模态框 begin-->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">
					<span>×</span>
				</button>
				<h4 class="modal-title" id="loginModalLabel">Login</h4>
			</div>
			<div class="modal-body">
				<form id="login-form">
					<div class="form-group">
						<label for="login-username" class="form-control-label">{$lang.username}:</label>
						<input type="text" class="form-control" id="login-username" placeholder="{$lang.username}">
					</div>
					<div class="form-group">
						<label for="login-password" class="form-control-label">{$lang.password}:</label>
						<input type="password" class="form-control" id="login-password" placeholder="{$lang.password}">
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<div class="alert alert-danger" role="alert" id="login-alert" style="display: none;"></div>
				<button type="button" class="btn btn-secondary" data-dismiss="modal">{$lang.cancel}</button>
				<button type="button" class="btn btn-primary" id="btn-login" onclick="login()">{$lang.login}</button>
			</div>
		</div>
	</div>
</div>
<!--登录所用之模态框 end-->

<!--测试结果之模态框 begin-->
<div class="modal fade" id="solutionModal" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">
					<a href="javascript:void(0)">
						<i class="fa fa-close"></i>
					</a>
				</button>
				<h5 class="modal-title" id="solutionModalLabel"><a target="_blank">#<span id="solution_id"></span></a></h5>
			</div>
			<div class="modal-body">
				<div id="info-panel">
					<table class="table table-reflow">
						<thead>
						<tr>
							<th width="15%">{$lang.run_id}</th>
							<th width="25%">{$lang.status}</th>
							<th width="20%">{$lang.code_length}</th>
							<th width="20%">{$lang.language}</th>
							<th width="20%">{$lang.submit_time}</th>
						</tr>
						</thead>
						<tbody>
						<tr>
							<td><span id="solution_id_2"></span></td>
							<td><span id="solution-result"></span><span id="solution-pending-spin">&nbsp;<i class="fa fa-refresh fa-spin"></i></span></td>
							<td id="solution-code-length"></td>
							<td id="solution-code-language"></td>
							<td id="solution-submittime"></td>
						</tr>
						</tbody>
					</table>
				</div>
				<div class="alert alert-warning" role="alert" id="ce-info" style="display: none"></div>
			</div>
		</div>
	</div>
</div>
<!--测试结果之模态框 end-->

<script type="text/javascript">
    function show_submit_code_modal(){
        $('#submit-source').val('');
        // 先判断用户是否已经登录
        $.get('/api/Login/islogin',function(d){
            if ('success' == d.status) {
                $('#submitModal').modal('show');
            }else{
                $('#loginModal').modal('show');
            }
        },'json');

    }

    function login(){
        var loginData = {
            'username': $('#login-username').val(),
            'password': $('#login-password').val()
        };
        $.post('/api/Login/login',loginData,function(d){
            if ('success' == d.status) {
                $('#loginModal').modal('hide');
                show_submit_code_modal();
            }else{
                $('#loginModal').modal('hide');
                layer.alert(d.msg,{},function(index){
                    layer.close(index);
                    show_submit_code_modal();
                });
            }
        },'json');
    }

    function status_monitor(solution_id){
        $.get('/api/Solution/status?solution_id='+solution_id,function(d){
            console.log(d);
            if (d.data.result < 4) {
                $('#solution-result').html(d.data.result_text);
                setTimeout(status_monitor(solution_id),100);
            }else{
                $('#solution-result').html(d.data.result_text);
                $('#solution-pending-spin').hide();
            }
        },'json');
    }

    function submit_code(){
        var codeData = {
            'contest_id': {$contest->contest_id},
            'problem_num': {$contest_problem->num},
            'language': $('#submit-language').val(),
            'code': $('#submit-source').val()
        };
        $.post('/api/Solution/submit_contest_problem_code',codeData,function(d){
            if ('success' == d.status) {
                $('#solution_id').html(d.data.solution_id);
                $('#solution_id_2').html(d.data.solution_id);
                $('#solution-code-length').html(d.data.code_length+' B');
                $('#solution-code-language').html(d.data.language_text);
                $('#solution-submittime').html(d.data.in_date);
                $('#solution-result').html('{$lang.contest_code_pending}');
                $('#submitModal').modal('hide');
                $('#solutionModal').modal('show');
                $('#solution-pending-spin').show();
                // 监控题目状态
                status_monitor(d.data.solution_id);
            }else{
            	$('#submit-alert').html(d.msg);
            	$('#submit-alert').show();
			}
        },'json');
    }

    // 源代码语言切换
    function language_change(){
        var lang_val = document.getElementById('submit-language').value;
        console.log(lang_val);
        localStorage.setItem("lang_val", lang_val);
    }

    $(function(){
        // 自动初始化语言
        var lang_val = localStorage.getItem('lang_val');
        if (null == lang_val || undefined == lang_val) {
            lang_val = 0;
        }
        document.getElementById('submit-language').value = lang_val;
    });
</script>
{/block}
